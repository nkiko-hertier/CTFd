{% extends "base.html" %}

{% block content %}
<!-- Replaced jumbotron with modern hero section -->
<div class="bg-gradient-to-br from-primary/5 to-accent/5 py-16">
  <div class="container mx-auto px-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="font-heading font-bold text-4xl text-foreground mb-4">
          {% trans %}Users{% endtrans %}
        </h1>
        <p class="text-muted-foreground text-lg">
          {% trans %}Discover and connect with fellow competitors{% endtrans %}
        </p>
      </div>
      
      <!-- User statistics -->
      <div class="mt-6 md:mt-0 grid grid-cols-2 gap-4 text-center">
        <div class="ctf-card p-4">
          <div class="text-2xl font-bold text-primary">{{ users.total }}</div>
          <div class="text-sm text-muted-foreground">{% trans %}Total Users{% endtrans %}</div>
        </div>
        <div class="ctf-card p-4">
          <div class="text-2xl font-bold text-accent">{{ users.page }}</div>
          <div class="text-sm text-muted-foreground">{% trans %}Current Page{% endtrans %}</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="py-8">
  <div class="container mx-auto px-4">
    <!-- Modern search section -->
    <div class="ctf-card p-6 mb-8">
      {% if q and field %}
        <div class="mb-6 text-center">
          <h3 class="font-heading font-semibold text-xl text-foreground mb-2">
            {% trans %}Search Results{% endtrans %}
          </h3>
          <p class="text-muted-foreground">
            {% trans %}Searching for users with <strong>{{ field }}</strong> matching <strong>{{ q }}</strong>{% endtrans %}
          </p>
          <p class="text-sm text-muted-foreground">
            {% trans page=users.page, total=users.total %}Page {{ page }} of {{ total }} results{% endtrans %}
          </p>
        </div>
      {% endif %}

      {% with form = Forms.users.PublicUserSearchForm(field=field, q=q) %}
        <form method="GET" class="flex flex-col md:flex-row gap-4 items-end">
          <div class="flex-shrink-0">
            <label class="block text-sm font-medium text-foreground mb-2">{% trans %}Search Field{% endtrans %}</label>
            {{ form.field(class="ctf-input") }}
          </div>
          
          <div class="flex-1">
            <label class="block text-sm font-medium text-foreground mb-2">{% trans %}Search Query{% endtrans %}</label>
            {{ form.q(class="ctf-input w-full", placeholder=form.q.description) }}
          </div>
          
          <button type="submit" class="ctf-button-primary flex items-center space-x-2">
            <i class="fas fa-search"></i>
            <span>{% trans %}Search{% endtrans %}</span>
          </button>
        </form>
      {% endwith %}
    </div>

    <!-- Modern users grid/table -->
    <div class="ctf-card overflow-hidden">
      <!-- Table header -->
      <div class="bg-muted/30 px-6 py-4 border-b border-border">
        <h3 class="font-heading font-semibold text-lg">{% trans %}Community Members{% endtrans %}</h3>
      </div>
      
      <!-- Responsive table -->
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-muted/10">
            <tr class="border-b border-border">
              <th class="px-6 py-4 text-left text-sm font-medium text-muted-foreground">
                {% trans %}User{% endtrans %}
              </th>
              <th class="px-6 py-4 text-center text-sm font-medium text-muted-foreground w-20">
                {% trans %}Website{% endtrans %}
              </th>
              <th class="px-6 py-4 text-left text-sm font-medium text-muted-foreground hidden md:table-cell">
                {% trans %}Affiliation{% endtrans %}
              </th>
              <th class="px-6 py-4 text-left text-sm font-medium text-muted-foreground hidden md:table-cell">
                {% trans %}Country{% endtrans %}
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-border">
            {% for user in users.items %}
              <tr class="hover:bg-muted/5 transition-colors">
                <!-- User name with badges -->
                <td class="px-6 py-4">
                  <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center">
                      <i class="fas fa-user text-primary"></i>
                    </div>
                    <div>
                      {% if scores_visible() %}
                        <a href="{{ url_for('users.public', user_id=user.id) }}" 
                           class="font-medium text-foreground hover:text-primary transition-colors">
                          {{ user.name | truncate(50) }}
                        </a>
                      {% else %}
                        <span class="font-medium text-foreground">{{ user.name | truncate(50) }}</span>
                      {% endif %}
                      
                      <!-- Badges -->
                      <div class="flex flex-wrap gap-1 mt-1">
                        {% if user.bracket_id %}
                          <span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-secondary/10 text-secondary rounded-md">
                            {{ user.bracket.name }}
                          </span>
                        {% endif %}
                        
                        {% if user.oauth_id %}
                          <a href="https://majorleaguecyber.org/u/{{ user.name }}" target="_blank" rel="noopener">
                            <span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-primary/10 text-primary rounded-md hover:bg-primary/20 transition-colors">
                              {% trans %}Official{% endtrans %}
                            </span>
                          </a>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </td>

                <!-- Website link -->
                <td class="px-6 py-4 text-center">
                  {% if user.website and (user.website.startswith('http://') or user.website.startswith('https://')) %}
                    <a href="{{ user.website }}" 
                       target="_blank" 
                       rel="noopener"
                       class="inline-flex items-center justify-center w-8 h-8 text-muted-foreground hover:text-primary hover:bg-primary/10 rounded-md transition-colors"
                       title="{{ user.website }}">
                      <i class="fas fa-external-link-alt"></i>
                    </a>
                  {% endif %}
                </td>

                <!-- Affiliation -->
                <td class="px-6 py-4 hidden md:table-cell">
                  {% if user.affiliation %}
                    {% if user.affiliation | length > 50 %}
                      <span class="text-muted-foreground" title="{{ user.affiliation }}">
                        {{ user.affiliation | truncate(50) }}
                      </span>
                    {% else %}
                      <span class="text-muted-foreground">
                        {{ user.affiliation | truncate(50) }}
                      </span>
                    {% endif %}
                  {% endif %}
                </td>

                <!-- Country -->
                <td class="px-6 py-4 hidden md:table-cell">
                  {% if user.country %}
                    <div class="flex items-center space-x-2">
                      <i class="flag-{{ user.country.lower() }} w-5 h-4"></i>
                      <span class="text-muted-foreground">{{ lookup_country_code(user.country) }}</span>
                    </div>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modern pagination -->
    {% if users.pages > 1 %}
      <div class="mt-8 flex items-center justify-center">
        <div class="flex items-center space-x-2">
          {% if users.page != 1 %}
            <a href="{{ prev_page }}" 
               class="inline-flex items-center px-3 py-2 text-sm font-medium text-muted-foreground hover:text-foreground hover:bg-accent/10 rounded-md transition-colors">
              <i class="fas fa-chevron-left mr-1"></i>
              {% trans %}Previous{% endtrans %}
            </a>
          {% endif %}

          <select class="ctf-input mx-4" onchange="window.location.href = updateUrlParameter(window.location.href, 'page', this.value)">
            {% for page in range(1, users.pages + 1) %}
              <option value="{{ page }}" {% if users.page == page %}selected{% endif %}>
                {% trans %}Page{% endtrans %} {{ page }}
              </option>
            {% endfor %}
          </select>

          {% if users.next_num %}
            <a href="{{ next_page }}" 
               class="inline-flex items-center px-3 py-2 text-sm font-medium text-muted-foreground hover:text-foreground hover:bg-accent/10 rounded-md transition-colors">
              {% trans %}Next{% endtrans %}
              <i class="fas fa-chevron-right ml-1"></i>
            </a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ Assets.js("assets/js/users/list.js") }}
  <script>
    function updateUrlParameter(url, param, paramVal) {
      var newAdditionalURL = "";
      var tempArray = url.split("?");
      var baseURL = tempArray[0];
      var additionalURL = tempArray[1];
      var temp = "";
      if (additionalURL) {
        tempArray = additionalURL.split("&");
        for (var i = 0; i < tempArray.length; i++) {
          if (tempArray[i].split('=')[0] != param) {
            newAdditionalURL += temp + tempArray[i];
            temp = "&";
          }
        }
      }
      var rows_txt = temp + "" + param + "=" + paramVal;
      return baseURL + "?" + newAdditionalURL + rows_txt;
    }
  </script>
{% endblock %}
